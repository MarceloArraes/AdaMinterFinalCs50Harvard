{% extends "nftminter/layout.html" %}

{% block body %}

<div class="image-container" >
  <form  class="image_form" id="image_form" method="post" enctype="multipart/form-data">
    <h2>Add a pic that you want to register</h2>
    {% csrf_token %}
        <input id="file" type="file" name="upload" accept="image/*">
        <br>
        <button id="img_uploaded" type="submit">Submit</button>
  </form>
  <div id="upload" class="upload"></div>
</div>

{% if file_url != 'fileURL' %}
<script>
  var file_url = '{{ file_url }}';
  var ipfs_hash = '{{ ipfs_hash }}';
</script>
{% else %}
<script>
  var file_url = 'fileURL';
  var ipfs_hash = 'ipfsHASH';
</script>
{% endif %}



<script type="text/babel">

  /* //button click event
  document.getElementById("img_uploaded").addEventListener("click", function(event) {
    console.log("button clicked");
    event.preventDefault();
    var file = document.getElementById("file").files[0];
    var formData = new FormData();
    formData.append("upload", file);
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "/upload", true);
    xhr.onload = function(e) {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          var file_url = xhr.responseText;
          var ipfs_hash = xhr.responseText.split("/")[1];
          console.log(file_url);
        };
  };};
}); */
  
  function CreateProject() {
    let caracteres = "aaaaaaaaaaaaaaaaaaaaaaaaaaabbbbb";
    const tamain = caracteres.length;
    const [metadata, setMetadata] = useState({
      title: "",
      author: "",
      description: "",
      fileWebLink: "ipfs://",
      arweaveId: "",
      nsfw: "",
    });
    const [receiverBalance, setReceiverBalance] = useState(0);
    const [fees, setFees]=useState(0);
    let paytest = false;

    const fieldUpdater = (name) => {
      function isTitle(evt) {
        var regex = /[A-Za-z0-9_]{0,32}/;

        if (regex.test(evt)) {
          var title = evt.match(regex)[0];
          return title;
        } else {
          return metadata["title"];
        }
      }

      function isOpcional(evt) {
        var regex = /[\w\s\uhhhh\u{hhhhh}u{hhhh}.@/:$%&*#!Â¨()\-+=]{0,64}/;

        if (regex.test(evt) && evt.length <= 63) {
          var title = evt.match(regex)[0];
          return title;
        } else {
          return metadata[event.target.name];
        }
      }

      if (event.target.name == "title") {
        setMetadata({
          ...metadata,
          [event.target.name]: isTitle(event.target.value),
        });
        return;
      }
      if (
        event.target.name == "description" ||
        event.target.name == "author" ||
        event.target.name == "fileWebLink" ||
        event.target.name == "arweaveId"
      ) {
        setMetadata({
          ...metadata,
          [event.target.name]: isOpcional(event.target.value),
        });
        return;
      } else if (event.target.name == "nsfw") {

        if(event.target.checked){
          setMetadata({
          ...metadata,
          [event.target.name]: 'true',
        });
        }else if(!event.target.checked){
          setMetadata({
          ...metadata,
          [event.target.name]: 'false',
        });
        }

      }
    };
   
    async function displayMetadata() {
    if (metadata.nsfw) {
      document.querySelector("#NSFW-checkbox").innerHTML = "NSFW IMAGE";
    } else {
      document.querySelector("#NSFW-checkbox").innerHTML = "";
    }
    var balance = await balanceCheck()
    let metaAndFee= await fetchFees()

    console.log("DISPLAY METADATA BALANCE LOG");
    console.log(balance.balance);

    setReceiverBalance(balance.balance)
    setFees(metaAndFee.fee)

    console.log("FEE: ");
    console.log(metaAndFee.fee);

    document.querySelector('.fee').innerHTML = metaAndFee.fee;

    document.querySelector('.content').innerHTML = metaAndFee.wallet.senderadress;
    document.querySelector(".metadata-container").style.display = "none";
    document.querySelector(".output").style.width = "20%";
    //document.querySelector(".output").style.textAlign = "left";

    document.querySelector(".payment-container").style.display = "inline-flex";

    
  }

         useEffect(() => {
           if(fees>0){
          const timer = setInterval(async() => {
            var newBalance = await balanceCheck()
            console.log("setInterval: ");
            console.log(newBalance['balance']);
            console.log(fees);
            console.log(receiverBalance);
            console.log(fees+receiverBalance);
            if(newBalance['balance']==fees+receiverBalance && fees>0 && receiverBalance!=newBalance['balance'] || paytest){
              console.log("ABSOLUTE SUCESS!!!!!!!!");
              //CANCELED i will call it on the submit of the user adress//now i can call for the mint-asset 
              //Here i will code the revealing of the className="useradress-container"
              //document.getElementById("submit_img").style.display = "none";
              document.querySelector(".payment-adress").style.display = "none";
              document.querySelector(".useradress-container").style.display = "block";
              
              //Register image on IPFS;
              clearInterval(timer);
            }
              else {console.log("Not Payed yet!");
            }
          
          }, 4000);
               // clearing interval
    return () => clearInterval(timer);
        }
        else console.log("Waiting metadata");
  },[fees]);
    
          useEffect(() => {
      console.log("useEffect");
      if(file_url == "fileURL"){
        console.log("file_url");
      }
      else{
        console.log(`${ipfs_hash}`);
        setMetadata({
          ...metadata,
          fileWebLink: `ipfs://${ipfs_hash}`,
      });
      var img = document.getElementById('output');
      var newPath = file_url;

      if(newPath.length>1){
        //img.src = newPath;
        img.src = "../static/media/" + file_url;
        //don't work, take too much time.//img.src = `ipfs://${ipfs_hash}`;
        document.querySelector(".metadata-container").style.display = "inline-flex";
        document.querySelector(".metadata-container").style.verticalAlign  = "top";
        document.querySelector(".image_form").style.display = "none";
      }
      

      }
    }, [file_url]);

    async function fetchFees() {
      let fees = await fetch('node',{
            method: "post",
             headers: {
                 "Content-Type": "application/json"
            },
            body: JSON.stringify(metadata)
 })
        .then((response) => response.json())
        .then((result) => {
          console.log(result)
          return result;
        });
        return fees
    }

    async function fetchMinter(mintInfo){
      console.log("entered fetchMinter");
      try{
      let minted = await fetch('mintAsset',{
            method: "post",
             headers: {
                 "Content-Type": "application/json"
            },
            //Another way to send the data.
            body: JSON.stringify(mintInfo)
 })
        .then((response) => response.json())
        .then((result) => {
          console.log("result from fetchMinter: ");
          console.log(result);
          return result;
        });
        
        return minted;}
        catch(error){
          console.log("error in fetchMinter");
          console.log(error);
        }
    }
    
    async function balanceCheck() {
      let balance = await fetch('balanceCheck',{
            method: "post",
             headers: {
                 "Content-Type": "application/json"
            },
            body: JSON.stringify(metadata)
 })
        .then((response) => response.json())
        .then((result) => {
          return result;
        });
        return balance;
    }

    async function mintAsset() {  
      let adress = document.querySelector("#user_adress").value
      console.log(adress);
      var mintInfo = {"adress": adress};
      
      Object.assign(mintInfo, metadata)
        
      let cnodeReturn = await fetchMinter(mintInfo);

      console.log("Return from fetchMinter() on mintAsset(): ");
      //var transactionHash = JSON.parse(cnodeReturn)
      //console.log(transactionHash);
      let transactionLink = "https://explorer.cardano-testnet.iohkdev.io/en/transaction?id=" + cnodeReturn["txHash"];
      document.querySelector("#transaction_link").href = transactionLink ;
    }

    async function copyAdress() {
        /* Get the text field */
        var copyText = document.querySelector(".content")

      /* Copy the text inside the text field */
      //navigator.clipboard.writeText(copyText.innerHTML);

      /* Alert the copied text */
      alert("Copied: " + copyText.innerHTML);

      //fazer o get-balance antes pra ver se tem saldo.
      var newBalance = await balanceCheck()
      console.log(newBalance['balance']);
      console.log(fees);
      console.log(receiverBalance);
      console.log(fees+receiverBalance);
      paytest = true;
      
    }

    return (
      <div id="projectCreate" className="projectCreate">
        <div className="metadata-container">          
          <label>
            Metadata:
            <div>
              Title:
              <p>
                <input
                  type="text"
                  onChange={fieldUpdater}
                  name="title"
                  value={metadata.title}
                />
              </p>
            </div>
            <div>
              Author:
              <p>
                <input
                  type="text"
                  onChange={fieldUpdater}
                  name="author"
                  value={metadata.author}
                />
              </p>
            </div>
            <div>
              Description:
              <p>
                <input
                  type="text"
                  onChange={fieldUpdater}
                  name="description"
                  value={metadata.description}
                />
              </p>
            </div>
            <div>
              File Web Link:
              <p>
                <input
                  type="text"
                  name="fileWebLink"
                  value={metadata.fileWebLink}
                />
              </p>
            </div>
            <div>
              Arweave ID:
              <p>
                <input
                  type="text"
                  onChange={fieldUpdater}
                  name="arweaveId"
                  value={metadata.arweaveId}
                />
              </p>
            </div>
            <div>
              NSFW:
              <p>
                <input type="checkbox" onChange={fieldUpdater} name="nsfw" />
              </p>
            </div>
            <div>
              <button
                type="submit"
                id="submit_metadata"
                onClick={displayMetadata}
              >Send Metadata</button>
            </div>
          </label>
        </div>
        
      <img className="output" id="output" alt="" />
        
      <div>
        
        <div className="payment-container">
          <div>
            Title:
            <p>
              <a>{metadata.title}</a>
            </p>
            Author:
            <p>
              <a>{metadata.author}</a>
            </p>
            Description:
            <p>
              <a>{metadata.description}</a>
            </p>
            Web Link:
            <p>
              <a>{metadata.fileWebLink}</a>
            </p>
            Arwave Id:
            <p>
              <a>{metadata.arweaveId}</a>
            </p>
            <p>
              <a id="NSFW-checkbox">{metadata.nsfw}</a>
            </p>
          </div>
          <div className="useradress-container">
            <p>Payment confirmed.</p>
            <p>Paste the adress that you want to receive the NFT:</p>
            <input id="user_adress" type="text" />
            <button
              type="button"
              value="Submit Adress"
              onClick={mintAsset}
            >Submit Adress</button>
          </div>
          <div>
            <h1 className="transaction_link">
            <a id="transaction_link" href="#">Transaction Link</a></h1>
          </div>
          <div className="payment-fee"></div>
          <div className="payment-adress">
            <p>Fee Cost:</p>
            <p className="fee"></p>
            <p>Send the fee value to this address: </p>
            <p className="content" ></p>
            <input
              type="submit"
              value="Copy Adress"
              id="copy_adress"
              onClick={copyAdress}
            />
          </div>
        </div>
        
      </div>


      </div>
    );
  }

  class Initial extends React.Component {
    render() {
      return (
        <div>
          <CreateProject />
        </div>
      );
    }
  }

  ReactDOM.render(<Initial />, document.querySelector("#upload"));
</script>
{% endblock %}
